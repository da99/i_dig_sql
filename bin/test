#!/usr/bin/env bash
# -*- bash -*-
#
#
x="$1"
set -u -e -o pipefail

if [[ "$x" == "watch" ]]; then
  shift

  echo ""
  echo "=== Watching: $@"

  echo -e "\n=== Running test:"
  bin/test "$@" || echo ""

  inotifywait -q -m -e close_write,close --exclude .git/ -r .  | while read CHANGE
  do

    dir=$(echo "$CHANGE" | cut -d' ' -f 1)
    op=$(echo "$CHANGE" | cut -d' ' -f 2)
    file=$(echo "$CHANGE" | cut -d' ' -f 3)
    path="${dir}$file"

    if [[ "$op" == *CLOSE_WRITE* && $file == *.rb*  ]]; then
      echo -e "\n=== Running test:"
      bin/test "$@" || echo ""
    fi

  done # === do

  echo ""
  exit 0
fi # === if watch

files="$(echo specs/*-$x.rb)"
if [[ -f "$files" ]]; then
  shift
else
  files="$(echo specs/*-*.rb)"
fi



bundle exec bacon -rpry -ri_dig_sql specs/helpers.rb $files "$@"


